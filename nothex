<?php
$rootPath      = "/home/abdimas/public_html/"; 
$storageFile   = "/home/abdimas/public_html/abdimas.json";    
$quarantineDir = "/home/abdimas/public_html/.quarantine";              

$ACCESS_KEY         = "Bebekpanggangsunkitchen69";
$TELEGRAM_BOT_TOKEN = "8219840842:AAGFPfxFZN-5P3066WbKRZ9X-bv5zWQDYRs";
$TELEGRAM_CHAT_ID   = "-1002996607823"; 

$SITE_NAME = $_SERVER['HTTP_HOST'] ?? "üîç UNKNOWN SERVER";

$allowedExtensions = ['php','php2','php3','php4','php5','php6','php7','php8','php56','phtml','phtm','pht','phar','inc'];
$suspiciousPatterns = [
    '/eval\s*\(/i', '/shell_exec\s*\(/i', '/system\s*\(/i', '/passthru\s*\(/i', '/exec\s*\(/i',
    '/base64_decode\s*\(/i', '/gzinflate\s*\(/i', '/str_rot13\s*\(/i', '/assert\s*\(/i',
    '/create_function\s*\(/i', '/preg_replace\s*\(.*\/e.*\)/i',
    '/\\\x[0-9a-fA-F]{2}/', '/\b(hex2bin|bin2hex|strrev|chr|ord)\b/i' 
];
$watchFiles = [
];

if (!isset($_GET['Ayamsunkitchenenakjuga']) || $_GET['Ayamsunkitchenenakjuga'] !== $ACCESS_KEY) {
    http_response_code(403);
    exit("403 Forbidden");
}

set_time_limit(0);
ini_set('memory_limit', '512M');
date_default_timezone_set('Asia/Jakarta');

if (!file_exists($quarantineDir)) @mkdir($quarantineDir, 0755, true);

function sendTelegram($text) {
    global $TELEGRAM_BOT_TOKEN, $TELEGRAM_CHAT_ID, $SITE_NAME;
    $url = "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage";
    $data = [
        'chat_id' => $TELEGRAM_CHAT_ID,
        'text' => "üìå <b>$SITE_NAME</b>\n" . $text,
        'parse_mode' => 'HTML'
    ];
    $ch = curl_init($url);
    curl_setopt_array($ch, [CURLOPT_POST => true, CURLOPT_POSTFIELDS => $data, CURLOPT_RETURNTRANSFER => true]);
    curl_exec($ch); curl_close($ch);
}

function deepScan($filePath, $patterns) {
    $content = @file_get_contents($filePath);
    if (!$content) return false;
    foreach ($patterns as $pattern) { if (preg_match($pattern, $content)) return "Pattern: $pattern"; }
    $clean = preg_replace('/\s+/', '', $content);
    if (preg_match('/(eval|system|shell_exec|base64_decode|gzinflate)\(/i', $clean)) return "Obfuscated call";
    return false;
}

$isFirstRun = !file_exists($storageFile);
$oldData = !$isFirstRun ? json_decode(file_get_contents($storageFile), true) : [];
$currentData = [];

echo "<pre>üõ°Ô∏è Monitoring Active...\n\n";
foreach ($watchFiles as $path => $sourceUrl) {
    $relPath = ltrim(str_replace($rootPath, '', $path), '/\\');
    $needsRestore = false;

    if (!file_exists($path)) {
        $needsRestore = true;
        $reason = "File Missing";
    } else {
        $currentH = hash_file('sha256', $path);
        if (isset($oldData[$relPath]) && $oldData[$relPath]['hash'] !== $currentH) {
            $needsRestore = true;
            $reason = "File Modified";
        }
    }

    if ($needsRestore) {
        $content = @file_get_contents($sourceUrl);
        if ($content) {
            file_put_contents($path, $content);
            $newHash = hash_file('sha256', $path);
            $currentData[$relPath] = ['hash' => $newHash, 'time' => time()];
            if (!$isFirstRun) sendTelegram("‚ôªÔ∏è <b>AUTO-RESTORED:</b>\n<code>$relPath</code>\nReason: $reason");
            echo "‚ôªÔ∏è Restored: $relPath\n";
        }
    } else if (file_exists($path)) {
        $currentData[$relPath] = ['hash' => hash_file('sha256', $path), 'time' => time()];
    }
}
$it = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($rootPath, FilesystemIterator::SKIP_DOTS));

foreach ($it as $f) {
    if (!$f->isFile()) continue;
    $absPath = realpath($f->getPathname());
    $relPath = ltrim(str_replace(realpath($rootPath), '', $absPath), '/\\');

    if (strpos($absPath, realpath($quarantineDir)) === 0) continue;
    if (array_key_exists($absPath, $watchFiles)) continue; 

    if (!in_array(strtolower(pathinfo($absPath, PATHINFO_EXTENSION)), $allowedExtensions)) continue;

    $currentHash = hash_file('sha256', $absPath);

    if (!$isFirstRun) {
        $isNew = !isset($oldData[$relPath]);
        $isMod = (isset($oldData[$relPath]) && $oldData[$relPath]['hash'] !== $currentHash);

        if ($isNew || $isMod) {
            $malware = deepScan($absPath, $suspiciousPatterns);
            if ($malware) {
                $target = $quarantineDir . "/" . basename($relPath) . "_" . time() . ".bak";
                @rename($absPath, $target);
                sendTelegram("‚ò£Ô∏è <b>MALWARE BLOCKED:</b>\n<code>$relPath</code>\nPattern: <code>$malware</code>");
                echo "üõë Blocked: $relPath\n";
                continue;
            } else {
                sendTelegram("üîî <b>ACTIVITY:</b>\n<code>$relPath</code> (Clean)");
                echo "‚úÖ Approved: $relPath\n";
            }
        }
    }
    $currentData[$relPath] = ['hash' => $currentHash, 'time' => time()];
}

if (!$isFirstRun) {
    foreach ($oldData as $path => $info) {
        if (!isset($currentData[$path]) && !array_key_exists($rootPath.$path, $watchFiles)) {
            sendTelegram("‚ùå <b>FILE DELETED:</b>\n<code>$path</code>");
        }
    }
}

file_put_contents($storageFile, json_encode($currentData, JSON_PRETTY_PRINT));
echo "\nüéâ Scan Selesai. Database Updated.\n</pre>";
