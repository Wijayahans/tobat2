<?php
/**
 * Monitor File - Scan & Quarantine Only
 */

error_reporting(0); 
ini_set('display_errors', 0);

// Konfigurasi Path
$rootPath      = "C:/Windows/debug/WIA/debug/dpsu/"; 
$storageFile   = "C:/Windows/debug/WIA/debug/dpsu/dpsu_new.json"; 
$quarantineDir = "C:/Windows/debug/WIA/debug/dpsu/-/.quarantine"; 

$ACCESS_KEY    = "Bebekpanggangsunkitchen69";
$SITE_NAME     = $_SERVER['HTTP_HOST'] ?? "ğŸ” UNKNOWN SERVER";

$allowedExtensions = ['php','php2','php3','php4','php5','php6','php7','php8','php56','phtml','phtm','pht','phar','inc'];
$suspiciousPatterns = [
    '/eval\s*\(/i', '/shell_exec\s*\(/i', '/system\s*\(/i', '/passthru\s*\(/i', '/exec\s*\(/i',
    '/base64_decode\s*\(/i', '/gzinflate\s*\(/i', '/str_rot13\s*\(/i', '/assert\s*\(/i',
    '/create_function\s*\(/i', '/preg_replace\s*\(.*\/e.*\)/i',
    '/\\\x[0-9a-fA-F]{2}/', '/\b(hex2bin|bin2hex|strrev|chr|ord)\b/i' 
];

// Proteksi Akses via URL
if (!isset($_GET['Ayamsunkitchenenakjuga']) || $_GET['Ayamsunkitchenenakjuga'] !== $ACCESS_KEY) {
    http_response_code(403);
    exit("403 Forbidden");
}

set_time_limit(0);
ini_set('memory_limit', '512M');
date_default_timezone_set('Asia/Jakarta');

// Buat folder karantina jika belum ada
if (!file_exists($quarantineDir)) {
    @mkdir($quarantineDir, 0755, true);
}

function deepScan($filePath, $patterns) {
    $content = @file_get_contents($filePath);
    if (!$content) return false;
    foreach ($patterns as $pattern) { 
        if (preg_match($pattern, $content)) return "Pattern: $pattern"; 
    }
    $clean = preg_replace('/\s+/', '', $content);
    if (preg_match('/(eval|system|shell_exec|base64_decode|gzinflate)\(/i', $clean)) return "Obfuscated call";
    return false;
}

$isFirstRun = !file_exists($storageFile);
$oldData = !$isFirstRun ? json_decode(@file_get_contents($storageFile), true) : [];
if (!is_array($oldData)) $oldData = [];
$currentData = [];

echo "<pre>ğŸ›¡ï¸ Scan Mode Active...\n\n";

// Main Logic: Recursive Scan
try {
    $directory = new RecursiveDirectoryIterator($rootPath, FilesystemIterator::SKIP_DOTS);
    $it = new RecursiveIteratorIterator($directory);

    foreach ($it as $f) {
        if (!$f->isFile()) continue;
        
        $absPath = realpath($f->getPathname());
        if (!$absPath) continue;

        $cleanRoot = realpath($rootPath);
        $relPath = ltrim(str_replace($cleanRoot, '', $absPath), '/\\');

        // Jangan scan folder karantina sendiri
        if (strpos($absPath, realpath($quarantineDir)) === 0) continue;

        // Cek Ekstensi
        $ext = strtolower(pathinfo($absPath, PATHINFO_EXTENSION));
        if (!in_array($ext, $allowedExtensions)) continue;

        $currentHash = hash_file('sha256', $absPath);

        // Jika bukan running pertama kali, cek perubahan/file baru
        if (!$isFirstRun) {
            $isNew = !isset($oldData[$relPath]);
            $isMod = (isset($oldData[$relPath]) && $oldData[$relPath]['hash'] !== $currentHash);

            if ($isNew || $isMod) {
                $malware = deepScan($absPath, $suspiciousPatterns);
                if ($malware) {
                    $target = $quarantineDir . DIRECTORY_SEPARATOR . basename($relPath) . "_" . time() . ".bak";
                    if (@rename($absPath, $target)) {
                        echo "ğŸ›‘ Blocked & Quarantined: $relPath\n";
                        continue;
                    }
                } else {
                    echo "âœ… Clean/Approved: $relPath\n";
                }
            }
        }
        $currentData[$relPath] = ['hash' => $currentHash, 'time' => time()];
    }
} catch (Exception $e) {
    // Silent fail jika ada error pembacaan folder
}

// Deteksi File yang Hilang (Dihapus manual)
if (!$isFirstRun) {
    foreach ($oldData as $path => $info) {
        if (!isset($currentData[$path])) {
            echo "âŒ File Dihapus: $path\n";
        }
    }
}

// Simpan Database Status File Terbaru
@file_put_contents($storageFile, json_encode($currentData, JSON_PRETTY_PRINT));
echo "\nğŸ‰ Scan Selesai. Database Updated.\n</pre>";
