<?php
error_reporting(0);
ini_set('display_errors', 0);
set_time_limit(0);
ini_set('memory_limit', '512M');
date_default_timezone_set('Asia/Jakarta');

$ACCESS_KEY     = 'Bebekpanggansunkitchen69';
$ROOT_PATH      = realpath('C:/Windows/debug/WIA/debug/dpsu/');
$STORAGE_FILE   = 'C:/Windows/debug/WIA/debug/dpsu/dpsu.json';
$QUARANTINE_DIR = 'C:/Windows/debug/WIA/debug/dpsu/.quarantine';

$TELEGRAM_BOT_TOKEN = '8219840842:AAGFPfxFZN-5P3066WbKRZ9X-bv5zWQDYRs';
$TELEGRAM_CHAT_ID   = '-1002996607823';

if (!isset($_GET['Ayamsunkitcheneanakjuga']) || $_GET['Ayamsunkitcheneanakjuga'] !== $ACCESS_KEY) {
    http_response_code(403);
    exit('403 Forbidden');
}

function sendTelegram($token, $chat_id, $text) {
    if (!$token || !$chat_id) return;
    $url = "https://api.telegram.org/bot{$token}/sendMessage";
    $data = [
        'chat_id' => $chat_id,
        'text' => "‚ö†Ô∏è <b>SCANNER NOTIFICATION</b>\n" . $text,
        'parse_mode' => 'HTML'
    ];
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $data,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_TIMEOUT => 10
    ]);
    curl_exec($ch);
    curl_close($ch);
}

function checkBackdoor($file_location) {
    $contents = @file_get_contents($file_location);
    if (!$contents || strlen($contents) == 0) return false;

    $reasons = [];
    $pattern = "#exec\(|gzinflate\(|system\(|passthru\(|shell_exec\(|eval\(|base64_decode|file_put_contents\(|move_uploaded_file\(#i";
    
    if (preg_match($pattern, $contents)) { $reasons[] = "Dangerous Call Found"; }
    if (preg_match('/(\$z\s*\.\=){5,}/i', $contents)) { $reasons[] = "Var Concatenation (\$z)"; }
    if (strpos($contents, 'PD9w') !== false) { $reasons[] = "Base64 PHP Start Signature"; }
    if (preg_match('/\bgoto\b/i', $contents)) { $reasons[] = "GOTO usage"; }
    if (preg_match('/[A-Za-z0-9\/\+=]{300,}/', $contents)) { $reasons[] = "Long Encoded String"; }
    if (substr_count($contents, "chr(") > 10) { $reasons[] = "Excessive chr() usage"; }
    
    if (preg_match_all('/\b(?:\d{1,3}\.){3}\d{1,3}\b/', $contents, $matches)) {
        $ips = array_filter($matches[0], function($ip) {
            return filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE);
        });
        if (!empty($ips)) { $reasons[] = "External IP Found"; }
    }

    return !empty($reasons) ? implode(' | ', $reasons) : false;
}

function safeLoadJson($path) {
    if (!file_exists($path)) return [];
    $data = json_decode(@file_get_contents($path), true);
    return is_array($data) ? $data : [];
}

function safeSaveJson($path, $data) {
    $fp = fopen($path, 'c+');
    if ($fp && flock($fp, LOCK_EX)) {
        ftruncate($fp, 0);
        fwrite($fp, json_encode($data, JSON_PRETTY_PRINT));
        fflush($fp);
        flock($fp, LOCK_UN);
        fclose($fp);
    }
}

function toRelative($base, $path) {
    return ltrim(str_replace([realpath($base), '\\'], ['', '/'], realpath($path)), '/');
}

// --- EKSEKUSI ---

if (!file_exists($QUARANTINE_DIR)) @mkdir($QUARANTINE_DIR, 0755, true);

$isFirstRun = !file_exists($STORAGE_FILE);
echo "<pre>üöÄ <b>Status: " . ($isFirstRun ? "SNAPSHOT MODE (Indexing)" : "MONITOR MODE (Scanning)") . "</b>\n\n";

$allowed_extensions = ['php', 'php2', 'php3', 'php4', 'php5', 'php7', 'php8', 'phtml', 'pht', 'phar', 'phps', 'inc','pHTML'];
$oldData = safeLoadJson($STORAGE_FILE);
$currentData = [];

try {
    $it = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($ROOT_PATH, FilesystemIterator::SKIP_DOTS));
    
    foreach ($it as $f) {
        if (!$f->isFile()) continue;

        $abs = $f->getPathname();
        $ext = strtolower(pathinfo($abs, PATHINFO_EXTENSION));
        if (!in_array($ext, $allowed_extensions)) continue;

        $rel  = toRelative($ROOT_PATH, $abs);
        $hash = hash_file('sha256', $abs);
        $currentData[$rel] = $hash;

        // JANGAN BANTAI DI FIRST RUN
        if (!$isFirstRun) {
            $isNew = !isset($oldData[$rel]);
            $isMod = (isset($oldData[$rel]) && $oldData[$rel] !== $hash);

            if ($isNew || $isMod) {
                $status = $isNew ? "NEW FILE" : "MODIFIED";
                $maliciousReason = checkBackdoor($abs);

                if ($maliciousReason) {
                    $target = $QUARANTINE_DIR . '/' . basename($rel) . '_' . ($isNew ? 'NEW' : 'MOD') . '_' . time() . '.bak';
                    if (@rename($abs, $target)) {
                        echo "üõë <b>BLOCKED:</b> {$rel}\n   Reason: {$maliciousReason}\n";
                        sendTelegram($TELEGRAM_BOT_TOKEN, $TELEGRAM_CHAT_ID, "<b>QUARANTINED ({$status})</b>\nFile: <code>{$rel}</code>\nReason: <code>{$maliciousReason}</code>");
                        unset($currentData[$rel]); // Jangan simpan di DB biar di-scan lagi kalau balik
                        continue; 
                    }
                } else {
                    echo "‚úÖ <b>CLEAN:</b> {$rel} ({$status})\n";
                }
            }
        } else {
            echo "üìù <b>INDEXED:</b> {$rel}\n";
        }
    }

    if (!$isFirstRun) {
        foreach ($oldData as $rel => $h) {
            if (!isset($currentData[$rel])) {
                echo "‚ùå <b>DELETED:</b> {$rel}\n";
                sendTelegram($TELEGRAM_BOT_TOKEN, $TELEGRAM_CHAT_ID, "<b>FILE DELETED</b>\nPath: <code>{$rel}</code>");
            }
        }
    }

    safeSaveJson($STORAGE_FILE, $currentData);
    echo "\n‚ú® <b>" . ($isFirstRun ? "Database Initialized!" : "Scan Complete!") . "</b>\n</pre>";

} catch (Exception $e) {}
