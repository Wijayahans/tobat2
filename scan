<?php
ini_set('display_errors', 1);
error_reporting(E_ALL);
set_time_limit(0);
ini_set('memory_limit', '512M');

$ROOT = realpath($_SERVER['DOCUMENT_ROOT']); 
$FOUND = [];

function checkBackdoor($file_location) {
    $contents = @file_get_contents($file_location);
    if (!$contents || strlen($contents) == 0) return false;

    $suspect = false;
    $reasons = [];

    // Logika deteksi tetap sama agar akurasi terjaga
    $pattern = "#exec\(|gzinflate\(|system\(|passthru\(|shell_exec\(|eval\(|base64_decode|file_put_contents\(|move_uploaded_file\(#i";
    if (preg_match($pattern, $contents)) { $suspect = true; $reasons[] = "Function: Dangerous Call Found"; }
    if (preg_match('/(\$z\s*\.\=){5,}/i', $contents)) { $suspect = true; $reasons[] = "Pattern: Variable Concatenation (\$z)"; }
    if (strpos($contents, 'PD9w') !== false) { $suspect = true; $reasons[] = "Signature: Base64 PHP Start"; }
    if (preg_match('/\bgoto\b/i', $contents)) { $suspect = true; $reasons[] = "Obfuscation: GOTO usage"; }
    if (preg_match('/[A-Za-z0-9\/\+=]{300,}/', $contents)) { $suspect = true; $reasons[] = "Obfuscation: Long Encoded String"; }
    if (substr_count($contents, "chr(") > 10) { $suspect = true; $reasons[] = "Obfuscation: Excessive chr() usage"; }
    
    // Deteksi IP Luar
    if (preg_match_all('/\b(?:\d{1,3}\.){3}\d{1,3}\b/', $contents, $matches)) {
        $ips = array_filter($matches[0], function($ip) {
            return filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE);
        });
        if (!empty($ips)) { $suspect = true; $reasons[] = "Hardcoded IP Found"; }
    }

    $preview = htmlspecialchars(substr($contents, 0, 5000));
    if (strlen($contents) > 5000) {
        $preview .= "\n\n[... KODE TERPOTONG: FILE TERLALU PANJANG UNTUK PREVIEW ...]";
    }

    return $suspect ? ['reasons' => $reasons, 'preview' => $preview] : false;
}

function run_scanner($dir) {
    global $FOUND;
    $items = @scandir($dir);
    if (!$items) return;

    // Tambahkan ekstensi target di sini
    $allowed_extensions = ['php', 'php3', 'php4', 'php5', 'phtml', 'phar'];

    foreach ($items as $item) {
        if ($item === '.' || $item === '..') continue;
        $path = $dir . DIRECTORY_SEPARATOR . $item;
        
        if (is_dir($path)) {
            run_scanner($path);
        } else {
            // Perubahan pada filter ekstensi
            $ext = strtolower(pathinfo($path, PATHINFO_EXTENSION));
            if (in_array($ext, $allowed_extensions)) {
                $res = checkBackdoor($path);
                if ($res) {
                    $FOUND[] = array_merge(['file' => $path, 'perm' => substr(sprintf('%o', fileperms($path)), -4)], $res);
                }
            }
        }
    }
}

// Action delete tetap sama
if (isset($_GET['del'])) {
    $f = realpath(base64_decode($_GET['del']));
    if ($f && strpos($f, $ROOT) === 0) {
        if(unlink($f)) { header("Location: ?status=deleted"); exit; }
    }
}

// Tampilan CSS tetap sama
echo "<style>
    body { background: #0a0a0a; color: #00ff41; font-family: 'Consolas', 'Monaco', monospace; padding: 30px; line-height: 1.5; }
    h2 { border-bottom: 2px solid #333; padding-bottom: 10px; color: #fff; }
    .card { background: #141414; border: 1px solid #00ff4133; padding: 20px; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .path { color: #00d4ff; font-size: 16px; font-weight: bold; margin-bottom: 10px; display: block; border-left: 4px solid #00d4ff; padding-left: 10px; }
    .reason-wrapper { margin: 10px 0; }
    .reason { background: #610000; color: #ff9b9b; padding: 4px 12px; border-radius: 4px; font-size: 13px; margin-right: 8px; font-weight: bold; border: 1px solid #ff0000; }
    .preview-box { 
        background: #050505; 
        color: #d1d1d1; 
        padding: 20px; 
        border: 1px solid #333; 
        font-size: 13px; 
        overflow: auto; 
        height: 500px; 
        margin-top: 15px; 
        white-space: pre; 
        border-radius: 5px;
        line-height: 1.6;
    }
    .btn-del { 
        background: #ff0040; color: #fff; text-decoration: none; 
        padding: 12px 25px; border-radius: 5px; display: inline-block; 
        margin-top: 20px; font-weight: bold; transition: 0.3s;
        text-transform: uppercase; letter-spacing: 1px;
    }
    .btn-del:hover { background: #fff; color: #ff0040; }
    .info { color: #888; margin-bottom: 20px; }
</style>";

echo "<h2>üõ°Ô∏è MALWARE AUDITOR MODE</h2>";
echo "<div class='info'>Directory: $ROOT <br>Target Ext: php, php3, php4, php5, phtml, phar <br>Preview Limit: 5,000 Characters</div>";

run_scanner($ROOT);

foreach ($FOUND as $item) {
    $enc = base64_encode($item['file']);
    echo "<div class='card'>";
    echo "<span class='path'>[!] FILE: {$item['file']} ({$item['perm']})</span>";
    
    echo "<div class='reason-wrapper'>";
    foreach ($item['reasons'] as $r) { echo "<span class='reason'>$r</span>"; }
    echo "</div>";

    echo "<div class='preview-box'>{$item['preview']}</div>";
    echo "<a href='?del=$enc' class='btn-del' onclick='return confirm(\"HAPUS FILE INI SEKARANG?\")'>‚ö†Ô∏è Hapus & Bersihkan</a>";
    echo "</div>";
}
?>
